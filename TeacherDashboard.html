<!DOCTYPE html>
<html lang="en">
<head>
    <title>6.2.4 Teacher Gradebook</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-container { max-width: 900px; margin: 40px auto; font-family: sans-serif; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        #searchBar { padding: 10px; border: 1px solid var(--gray-med); border-radius: 5px; flex-grow: 1; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        th { background: var(--black); color: white; cursor: pointer; padding: 15px; text-align: left; }
        th:hover { background: #333; }
        td { padding: 12px; border-bottom: 1px solid var(--gray-med); }
        
        .complete { color: var(--kelly-green); font-weight: bold; }
        .pending { color: var(--gray-text); font-style: italic; opacity: 0.7; }
        .summary-pill { background: var(--gray-light); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid var(--gray-med); }
    </style>
</head>
<body class="dashboard-container">

    <h1>6.2.4 <span class="accent-text">Completion Tracker</span></h1>

    <div class="controls">
        <input type="text" id="searchBar" onkeyup="filterTable()" placeholder="Search for a student name...">
        <div class="summary-pill">Finished: <span id="finished-count">0</span></div>
        <button onclick="loadGrades()">Refresh Data</button>
    </div>
    
    <table id="gradeTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Student Name ↕</th>
                <th onclick="sortTable(1)">Status ↕</th>
                <th onclick="sortTable(2)">Time Finished ↕</th>
            </tr>
        </thead>
        <tbody id="grade-body">
            <tr><td colspan="3">Loading classroom data...</td></tr>
        </tbody>
    </table>

    <script>
        const SB_URL = "https://khazeoycsjdqnmwodncw.supabase.co";
        const SB_KEY = "YOUR_ANON_KEY"; 
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        async function loadGrades() {
            const { data, error } = await supabaseClient
                .from('assignment')
                .select('userName, C624_Completed, updated_at');

            if (error) return console.error("Fetch error:", error);

            let finished = 0;
            const body = document.getElementById('grade-body');
            
            body.innerHTML = data.map(row => {
                if(row.C624_Completed) finished++;
                
                const completionTime = row.C624_Completed ? 
                    new Date(row.updated_at).toLocaleString([], {month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'}) : 
                    "—";
                
                return `
                    <tr>
                        <td><strong>${row.userName}</strong></td>
                        <td class="${row.C624_Completed ? 'complete' : 'pending'}">
                            ${row.C624_Completed ? '✅ Complete' : '⏳ In Progress'}
                        </td>
                        <td data-time="${row.updated_at || ''}">${completionTime}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('finished-count').innerText = finished;
        }

        function filterTable() {
            const input = document.getElementById("searchBar").value.toUpperCase();
            const rows = document.getElementById("grade-body").getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                const nameCell = rows[i].getElementsByTagName("td")[0];
                if (nameCell) {
                    const textValue = nameCell.textContent || nameCell.innerText;
                    rows[i].style.display = textValue.toUpperCase().indexOf(input) > -1 ? "" : "none";
                }
            }
        }

        function sortTable(n) {
            const table = document.getElementById("gradeTable");
            let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            switching = true;
            dir = "asc"; 
            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    
                    let valX = n === 2 ? x.getAttribute('data-time') : x.innerText.toLowerCase();
                    let valY = n === 2 ? y.getAttribute('data-time') : y.innerText.toLowerCase();

                    if (dir == "asc") {
                        if (valX > valY) { shouldSwitch = true; break; }
                    } else if (dir == "desc") {
                        if (valX < valY) { shouldSwitch = true; break; }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount ++;      
                } else if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }

        window.onload = loadGrades;
    </script>
</body>
</html>
