<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6.2.4 System Test Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="skill_transformation.js"></script>
    <script src="skill_linearsystem.js"></script>
    <script src="skill_figuregrowth.js"></script>
    <script src="skill_solveX.js"></script>
    <script src="skill_boxplot.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .version-pill {
            font-family: monospace;
            font-size: 0.8rem;
            background: #edf2f7;
            padding: 4px 10px;
            border-radius: 5px;
            border: 1px solid #cbd5e0;
        }
        .test-controls { background: #f1f5f9; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px dashed #cbd5e0; }
        .log-box { background: #1a1a1a; color: #4CBB17; padding: 15px; font-family: monospace; border-radius: 8px; margin-top: 10px; max-height: 150px; overflow-y: auto; }
        #work-area { margin-top: 20px; padding: 20px; border: 1px solid #eee; border-radius: 10px; }
    </style>
</head>
<body class="container">

    <div class="test-header">
        <h1>Dev <span class="accent-text">Tester</span></h1>
        <span class="version-pill">Local Version: v1.0.3</span>
    </div>

    <div class="test-controls">
        <h3>1. Session Mocking</h3>
        <button onclick="mockSession('test_user', '6.2.4')">Mock Lesson 6.2.4 Session</button>
        <span id="session-status">No Session</span>

        <h3>2. UI & Component Check</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
            <button onclick="log('Loading X...'); initSolveXGame()">Solve X</button>
            <button onclick="log('Loading Box...'); initBoxPlotGame()">Box Plot</button>
            <button onclick="log('Loading Logic...'); initLinearSystemGame()">Linear Systems</button>
            <button onclick="log('Loading Growth...'); initFigureGrowthGame()">Figure Growth</button>
            <button onclick="log('Loading Trans...'); initTransformationGame()">Transformations</button>
        </div>

        <h3>3. Routing Diagnostic</h3>
        <button onclick="testNeedBasedRouting()" style="background: #000; color: #fff; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Run Routing Diagnostic</button>
    </div>

    <div id="log" class="log-box">System ready for testing...</div>
    
    <hr style="margin: 30px 0;">

    <div id="work-area">
        <h2 id="q-title">Assignment UI Output:</h2>
        <div id="q-content"><em>The game UI will render here...</em></div>
        <div id="feedback-box"></div>
    </div>

    <script>
        // Mocking Globals
        let currentUser = '';
        let targetLesson = '';
        let isCurrentQActive = false;
        let currentQSeconds = 0;
        let currentQCap = 60;

        function log(msg) {
            const l = document.getElementById('log');
            l.innerHTML += `<br>> ${msg}`;
            l.scrollTop = l.scrollHeight;
        }

        function mockSession(user, lesson) {
            currentUser = user;
            targetLesson = lesson;
            sessionStorage.setItem('current_user', user);
            sessionStorage.setItem('target_lesson', lesson);
            document.getElementById('session-status').innerText = `Active: ${user}`;
            log(`Session set: ${user}`);
            loadNextQuestion();
        }

        async function loadNextQuestion() {
            log("Hub requested next question...");
            testNeedBasedRouting();
        }

        async function testNeedBasedRouting() {
            if (!currentUser) {
                log("Error: No user set. Click Mock Session first.");
                return;
            }
            log("Fetching scores from Supabase...");
            try {
                const { data, error } = await supabaseClient
                    .from('assignment')
                    .select('*')
                    .eq('userName', currentUser)
                    .single();

                if (error) throw error;

                // !!! DOUBLE CHECK THESE NAMES MATCH YOUR SUPABASE COLUMNS !!!
                const skills = [
                    { name: 'SolveX', score: data.SolveX || 0, fn: initSolveXGame },
                    { name: 'BoxPlot', score: data.BoxPlot || 0, fn: initBoxPlotGame },
                    { name: 'LinearSystem', score: data.LinearSystem || 0, fn: initLinearSystemGame },
                    { name: 'FigureGrowth', score: data.FigureGrowth || 0, fn: initFigureGrowthGame },
                    { name: 'C6Transformation', score: data.C6Transformation || 0, fn: initTransformationGame }
                ];

                skills.sort((a, b) => a.score - b.score);
                log(`LOWEST SCORE: ${skills[0].name} (${skills[0].score}/10)`);
                skills[0].fn();

            } catch (e) {
                log("Routing Test Failed. See Browser Console (F12).");
                console.error("Diagnostic Error:", e);
            }
        }

        async function finishAssignment() {
            log("üèÅ TARGET REACHED.");
            alert("12 Minute threshold crossed.");
        }
    </script>

    <script src="assignment_hub.js"></script>
</body>
</html>
